name: picard
grade: stable
confinement: strict
base: core18
adopt-info: picard

apps:
  picard:
    common-id: org.musicbrainz.Picard
    command: bin/picard
    environment:
      DISABLE_WAYLAND: 1
      QT_QPA_PLATFORMTHEME: gtk3
    extensions:
      - kde-neon
    plugs:
      - gsettings
      - home
      - network
      - network-bind
      - network-manager-observe
      - opengl
      - optical-drive
      - pulseaudio
      - removable-media
      - unity7
    command-chain:
      - bin/app-launch

plugs:
  # gtk-common-themes support
  gtk-3-themes:
    interface: content
    target: $SNAP/data-dir/themes
    default-provider: gtk-common-themes:gtk-3-themes

# slots:
#   session-dbus-interface:
#     interface: dbus
#     name: org.musicbrainz.Picard.desktop
#     bus: session

parts:
  picard:
    after:
      - patching
      - selective-checkout

    source: https://github.com/metabrainz/picard.git
    #source-depth: 1000
    plugin: python
    # requirements:
    #   - requirements.txt
    parse-info:
      - share/metainfo/org.musicbrainz.Picard.appdata.xml
    override-pull: |
      snapcraftctl pull
      "$SNAPCRAFT_STAGE"/scriptlets/selective-checkout \
                        --release-tag-prefix='release-' \
                        --stable-tag-pattern=^[[:digit:]].[[:digit:]]\(.[[:digit:]]\)?$ \
                        --beta-tag-pattern=^[[:digit:]].[[:digit:]].[[:digit:]]b[[:digit:]]$ \
                        --release-candidate-tag-pattern=^[[:digit:]].[[:digit:]].[[:digit:]]rc[[:digit:]]$

    override-build: |
      git apply --verbose "${SNAPCRAFT_STAGE}"/patching/*.patch
      snapcraftctl build
    prime:
      - -lib/python3.*/site-packages/PyQt5*
    stage-packages:
      - libchromaprint-tools
      - libdiscid0
      - libgettextpo0
      - libqt5multimedia5-plugins
      - python3-aubio  # for the BPM plugin
      - python3-libdiscid
      - python3-markdown
      - python3-pyqt5
      - python3-pyqt5.qtmultimedia
    build-packages:
      - appstream
      - gettext

  # Additional packages for better desktop integration and theming
  desktop-theming:
    plugin: nil
    stage-packages:
      - qt5-gtk-platformtheme
      - ttf-ubuntu-font-family

  # Custom launch scripts
  command-chain:
    plugin: dump
    source: command-chain
    organize:
      '*': bin/
    stage-packages:
      - librsvg2-common  # For SVG icon support in GTK file picker

  # Code patching to fix another part, when it cannot be solved by other means
  patching:
    source: patching
    plugin: dump
    organize:
      '*': patching/
    prime:
      - -*

  # Check out the tagged release revision if it isn't promoted to the stable channel
  # https://forum.snapcraft.io/t/selective-checkout-check-out-the-tagged-release-revision-if-it-isnt-promoted-to-the-stable-channel/10617
  selective-checkout:
    plugin: nil
    build-packages:
      - git
    stage-snaps:
      - selective-checkout
    prime:
      - -*
